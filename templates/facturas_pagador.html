{% extends "base.html" %}
{% block content %}
<h2 class="text-xl font-bold mb-4">Panel de Facturas - {{ pagador_nombre }}</h2>

<!-- Mensajes de √©xito o error -->
{% if request.query_params.msg == 'confirmada' %}
  <div class="alert alert-success">‚úÖ Factura confirmada correctamente.</div>
{% elif request.query_params.msg == 'rechazada' %}
  <div class="alert alert-warning">‚ö†Ô∏è Factura rechazada correctamente.</div>
{% elif request.query_params.msg == 'fecha_actualizada' %}
  <div class="alert alert-info">üìÖ Fecha de vencimiento actualizada.</div>
{% elif request.query_params.msg == 'error' %}
  <div class="alert alert-danger">‚ùå No se pudo procesar la acci√≥n.</div>
{% endif %}

<!-- üîΩ Importar desde JSON -->
<form action="/pagador/importar_facturas" method="post" enctype="multipart/form-data" class="mb-4 d-flex align-items-center gap-3">
  <label class="form-label"><i class="bi bi-upload"></i> Importar facturas desde JSON</label>
  <input class="form-control form-control-sm" type="file" name="archivo">
  
  <button class="btn btn-primary btn-sm" type="submit">Subir facturas</button>
</form>

<!-- Tabs con Bootstrap -->
<ul class="nav nav-tabs mb-4" id="facturaTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab">
      üßæ Pendientes
      <span class="badge bg-secondary">{{ facturas_pendientes|length }}</span>
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="solicitadas-tab" data-bs-toggle="tab" data-bs-target="#solicitadas" type="button" role="tab">
      üì© Solicitadas
      <span class="badge bg-secondary">{{ facturas_solicitadas|length }}</span>
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
      üìÅ Historial
      <span class="badge bg-secondary">{{ facturas_gestionadas|length }}</span>
    </button>
  </li>
</ul>

<!-- Contenido de cada tab -->
<div class="tab-content" id="facturaTabsContent">
  <!-- üßæ Pendientes -->
  <div class="tab-pane fade show active" id="pendientes" role="tabpanel">
    <h5>Facturas cargadas por el pagador</h5>
    {% if facturas_pendientes %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Folio</th>
          <th>Proveedor</th>
          <th>Emisi√≥n</th>
          <th>Vencimiento</th>
          <th>Monto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas_pendientes %}
        <tr>
          <td>{{ factura.folio }}</td>
          <td>{{ factura.razon_social_emisor }}</td>
          <td>{{ factura.fecha_emision }}</td>
          <td>
            <form action="/pagador/editar-vencimiento/{{ factura.folio }}" method="post">
              <input type="date" name="nueva_fecha_vencimiento" value="{{ factura.fecha_vencimiento }}">
              <button type="submit" class="btn btn-sm btn-outline-primary">Cambiar</button>
            </form>
          </td>
          <td>${{ "{:,.0f}".format(factura.monto) }}</td>
          <td>
            <form action="/pagador/confirmar-factura/{{ factura.folio }}" method="post" style="display:inline;">
              <button class="btn btn-sm btn-success" type="submit">Confirmar</button>
            </form>
            <form action="/pagador/rechazar-factura/{{ factura.folio }}" method="post" style="display:inline;">
              <button class="btn btn-sm btn-danger" type="submit">Rechazar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No hay facturas pendientes cargadas por el pagador.</p>
    {% endif %}
  </div>

  <!-- üì© Solicitadas -->
  <div class="tab-pane fade" id="solicitadas" role="tabpanel">
    <h5>Facturas con solicitud del proveedor</h5>
    {% if facturas_solicitadas %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Folio</th>
          <th>Proveedor</th>
          <th>Emisi√≥n</th>
          <th>Vencimiento</th>
          <th>Monto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas_solicitadas %}
        <tr>
          <td>{{ factura.folio }}</td>
          <td>{{ factura.razon_social_emisor }}</td>
          <td>{{ factura.fecha_emision }}</td>
          <td>
            <form action="/pagador/editar-vencimiento/{{ factura.folio }}" method="post">
              <input type="date" name="nueva_fecha_vencimiento" value="{{ factura.fecha_vencimiento }}">
              <button type="submit" class="btn btn-sm btn-outline-primary">Cambiar</button>
            </form>
          </td>
          <td>${{ "{:,.0f}".format(factura.monto) }}</td>
          <td>
            <form action="/pagador/confirmar-factura/{{ factura.folio }}" method="post" style="display:inline;">
              <button class="btn btn-sm btn-success" type="submit">Confirmar</button>
            </form>
            <form action="/pagador/rechazar-factura/{{ factura.folio }}" method="post" style="display:inline;">
              <button class="btn btn-sm btn-danger" type="submit">Rechazar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No hay facturas solicitadas por proveedores.</p>
    {% endif %}
  </div>

  <!-- üìÅ Historial -->
  <div class="tab-pane fade" id="historial" role="tabpanel">
    <h5>Historial de facturas gestionadas</h5>
    {% if facturas_gestionadas %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Folio</th>
          <th>Proveedor</th>
          <th>Estado</th>
          <th>Vencimiento</th>
          <th>Origen</th>
          <th>Aceptaci√≥n</th>
          <th>D√≠as desde emisi√≥n</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas_gestionadas %}
        <tr>
          <td>{{ factura.folio }}</td>
          <td>{{ factura.razon_social_emisor }}</td>
          <td>{{ factura.estado_dte }}</td>
          <td>{{ factura.fecha_vencimiento }}</td>
          <td>
            {% if factura.origen_confirmacion == "Carga proveedor" %}
              <span class="badge bg-info text-dark">Proveedor</span>
            {% elif factura.origen_confirmacion == "Importaci√≥n pagador" %}
              <span class="badge bg-warning text-dark">Pagador</span>
            {% else %}
              {{ factura.origen_confirmacion }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No hay historial de facturas gestionadas a√∫n.</p>
    {% endif %}
  </div>
</div>

{% endblock %}
