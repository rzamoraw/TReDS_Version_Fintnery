{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h2>Ofertas recibidas ‚Äî Factura {{ factura.folio }}</h2>

  <!-- Datos clave de la factura -->
  <div class="mb-2">
    <strong>Monto:</strong> ${{ '{:,.0f}'.format(factura.monto or 0) }} |
    <strong>Vencimiento vigente:</strong> {{ factura.fecha_vencimiento }}
  </div>
  <div class="mb-3">
    <strong>Pagador:</strong> {{ factura.razon_social_receptor or '‚Äî' }}
    <small class="text-muted ms-2">RUT: {{ factura.rut_receptor or '‚Äî' }}</small>
  </div>

  <!-- Mensajes (desde query params) -->
  {% set msg = request.query_params.get('msg') %}
  {% if msg == "oferta_adjudicada" %}
    <div class="alert alert-success mt-3">
      üéâ Oferta adjudicada correctamente. Pronto recibir√°s el confirming.
    </div>
  {% endif %}

  {% if bloqueado %}
    <div class="alert alert-info mt-2">
      Esta factura ya fue <strong>adjudicada</strong>. No es posible adjudicar otra oferta.
    </div>
  {% endif %}

  {% if ofertas and ofertas|length > 0 %}
    <table class="table table-bordered table-hover mt-4 bg-white">
      <thead class="table-light">
        <tr>
          <th>Fondo</th>
          <th>Financiador</th>
          <th class="text-end">Tasa total mensual (%)</th>
          <th class="text-end">D√≠as (vigentes)</th>
          <th class="text-end">Comisi√≥n flat ($)</th>
          <th class="text-end"><strong>Precio cesi√≥n ($)</strong></th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody>
        {% for oferta in ofertas %}
          <tr>
            <td>{{ oferta.financiador.fondo.nombre if oferta.financiador and oferta.financiador.fondo else '‚Äî' }}</td>
            <td>{{ oferta.financiador.nombre if oferta.financiador else '‚Äî' }}</td>

            <!-- Tasa total mensual calculada en backend: tasa_interes + costo_fondos_mensual -->
            <td class="text-end">
              {% if oferta._tasa_total_mensual is not none %}
                {{ '%.2f' % (oferta._tasa_total_mensual * 100) }}
              {% else %} N/D {% endif %}
            </td>

            <!-- D√≠as vigentes hasta el vencimiento (no negativos) -->
            <td class="text-end">{{ oferta._dias_vigentes if oferta._dias_vigentes is not none else 'N/D' }}</td>

            <td class="text-end">${{ '{:,.0f}'.format(oferta.comision_flat or 0) }}</td>

            <!-- Precio de cesi√≥n calculado con vencimiento vigente -->
            <td class="text-end">
              {% if oferta._precio_cesion_calc is not none %}
                <strong>${{ '{:,.0f}'.format(oferta._precio_cesion_calc) }}</strong>
              {% else %} N/D {% endif %}
            </td>

            <td>
              {% if bloqueado %}
                {% if oferta.estado == "Adjudicada" %}
                  <span class="badge bg-success">Adjudicada</span>
                {% else %}
                  <span class="badge bg-secondary">No adjudicada</span>
                {% endif %}
              {% else %}
                <form method="post" action="/proveedor/aceptar-oferta/{{ oferta.id }}">
                  <button class="btn btn-sm btn-success">‚úÖ Adjudicar</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-info mt-4">
      No se han recibido ofertas a√∫n para esta factura.
    </div>
  {% endif %}

  <a href="/proveedor/facturas" class="btn btn-outline-secondary mt-3">‚Üê Volver a mis facturas</a>
</div>
{% endblock %}