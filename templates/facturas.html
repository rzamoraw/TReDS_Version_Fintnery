{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Mis Facturas</h2>
    <a href="/proveedor/logout" class="btn btn-outline-secondary">Cerrar sesi√≥n</a>
  </div>

  <!-- Tabs de navegaci√≥n -->
  <ul class="nav nav-tabs mb-4" id="facturasTabs" role="tablist">
    <!-- üü¶ 1. Cargadas -->
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="cargadas-tab" data-bs-toggle="tab" data-bs-target="#cargadas" type="button" role="tab" aria-controls="cargadas" aria-selected="true">
      üìù Cargadas <span class="badge bg-secondary">{{ facturas_cargadas | length }}</span>
    </button>
  </li>
  <!-- üü® 2. Pendientes -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab" aria-controls="pendientes" aria-selected="false">
      üìå Pendientes <span class="badge bg-secondary">{{ facturas_pendientes | length }}</span>
    </button>
  </li>
  <!-- ‚úÖ 3. Confirmadas -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="confirmadas-tab" data-bs-toggle="tab" data-bs-target="#confirmadas" type="button" role="tab" aria-controls="confirmadas" aria-selected="false">
      ‚úÖ Confirmadas <span class="badge bg-secondary">{{ facturas_confirmadas | length }}</span>
    </button>
  </li>
  <!-- üìä 4. Confirming solicitado -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="confirming-tab" data-bs-toggle="tab" data-bs-target="#confirming" type="button" role="tab" aria-controls="confirming" aria-selected="false">
      üìö Confirming solicitado <span class="badge bg-secondary">{{ facturas_confirming | length }}</span>
    </button>
  </li>
  <!-- 5) Adjudicadas -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="adjudicadas-tab" data-bs-toggle="tab"
          data-bs-target="#adjudicadas" type="button" role="tab"
          aria-controls="adjudicadas" aria-selected="false">
    üèÅ Adjudicadas <span class="badge bg-secondary">{{ total_adjudicadas }}</span>
    </button>
</li>
</ul>

  <div class="tab-content" id="facturasTabsContent">

    <!-- üìù Tab: Cargadas -->
    <div class="tab-pane fade show active" id="cargadas" role="tabpanel" aria-labelledby="cargadas-tab">

      <!-- üßæ Subida de XML / ZIP -->
      <form action="/proveedor/facturas" method="post" enctype="multipart/form-data" class="mb-4">
        <label class="form-label me-2 fw-semibold">Subir archivo (XML o ZIP):</label>
        <input type="file" name="archivo" accept=".xml,.zip" class="form-control d-inline-block w-auto me-2" required>
        <button class="btn btn-primary">üì§ Cargar</button>
      </form>

      <!-- üì• Importaci√≥n SII -->
      <div class="mb-4">
        <form method="GET" action="/proveedor/importar_sii_facturas">
          <button type="submit" class="btn btn-primary" style="font-size: 1rem; padding: 10px 20px;">
            üì• Importar desde SII (√∫ltima descarga)
          </button>
        </form>
        <small class="text-muted ms-2">Se cargar√°n las facturas del √∫ltimo JSON descargado desde el portal del SII.</small>
      </div>

      <!-- ‚úçÔ∏è Carga manual -->
      <p>
        <a class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" href="#collapseManual" role="button">
          ‚ûï Cargar factura manualmente
        </a>
      </p>
      <div class="collapse" id="collapseManual">
        <div class="card card-body mb-4">
          <form action="/proveedor/facturas" method="post" class="row g-3">
            <div class="col-md-2"><label class="form-label">Folio</label><input type="number" name="folio" class="form-control" required></div>
            <div class="col-md-2"><label class="form-label">RUT Receptor</label><input type="text" name="rut_receptor" class="form-control" required></div>
            <div class="col-md-2"><label class="form-label">Raz√≥n Social Receptor</label><input type="text" name="razon_social_receptor" class="form-control" required></div>
            <div class="col-md-2"><label class="form-label">Tipo DTE</label><input type="text" name="tipo_dte" class="form-control" required></div>
            <div class="col-md-2"><label class="form-label">Monto</label><input type="number" name="monto" class="form-control" required></div>
            <div class="col-md-2"><label class="form-label">F. Emisi√≥n</label><input type="date" name="fecha_emision" class="form-control" required></div>
            <div class="col-md-2"><label class="form-label">F. Venc.</label><input type="date" name="fecha_vencimiento" class="form-control" required></div>
            <div class="col-12 text-end"><button class="btn btn-success">Guardar factura</button></div>
          </form>
          <small class="text-muted">*Este formulario es opcional.</small>
        </div>
      </div>

      <h5 class="text-primary mb-3">üìù Facturas cargadas (puede solicitar confirmaci√≥n)</h5>
      <div class="table-responsive mb-5">
        <table class="table table-bordered table-hover bg-white">
          <thead class="table-light">
            <tr>
              <th>Folio</th>
              <th>Emisor</th>
              <th>Receptor</th>
              <th>Monto</th>
              <th>F. Emisi√≥n</th>
              <th>F. Venc.</th>
              <th>Origen</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for factura in facturas if factura.estado_dte == "Cargada" %}
            <tr>
              <td>{{ factura.folio }}</td>
              <td>{{ factura.razon_social_emisor }}</td>
              <td>{{ factura.razon_social_receptor }}</td>
              <td>${{ '{:,.0f}'.format(factura.monto) }}</td>
              <td>{{ factura.fecha_emision }}</td>
              <td>{{ factura.fecha_vencimiento }}</td>
              <td>{{ factura.origen_confirmacion or "Desconocido" }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary solicitar-confirmacion" data-folio="{{ factura.folio }}">
                    Solicitar confirmaci√≥n
                 </button>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">Sin facturas cargadas para gestionar.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- üìå Tab: Pendientes -->
    <div class="tab-pane fade" id="pendientes" role="tabpanel" aria-labelledby="pendientes-tab">
      <p class="text-muted">Aqu√≠ se mostrar√°n las facturas con estado pendiente (confirmaci√≥n solicitada o rechazadas).</p> 
      <h5 class="text-warning mb-3">üìå Facturas pendientes</h5>
      <div class="table-responsive mb-5">
        <table class="table table-bordered table-hover bg-white">
          <thead class="table-light">
            <tr>
              <th>Folio</th>
              <th>Emisor</th>
              <th>Receptor</th>
              <th>Monto</th>
              <th>F. Emisi√≥n</th>
              <th>F. Venc.</th>
              <th>Origen</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for factura in facturas if factura.estado_dte in ["Confirmaci√≥n solicitada al pagador", "Rechazada por pagador"] %}
            <tr>
              <td>{{ factura.folio }}</td>
              <td>{{ factura.razon_social_emisor }}</td>
              <td>{{ factura.razon_social_receptor }}</td>
              <td>${{ '{:,.0f}'.format(factura.monto) }}</td>
              <td>{{ factura.fecha_emision }}</td>
              <td>{{ factura.fecha_vencimiento }}</td>
              <td>{{ factura.origen_confirmacion or "Desconocido" }}</td>
              <td>
                {% if factura.estado_dte == "Confirmaci√≥n solicitada al pagador" %}
                  <span class="text-info">Confirmaci√≥n solicitada</span>
                {% elif factura.estado_dte == "Rechazada por pagador" %}
                  <span class="text-danger">Rechazada por pagador</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">Sin facturas pendientes.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if facturas_descartadas %}
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Alerta:</strong> Se omitieron {{ facturas_descartadas|length }} factura(s) por tener condici√≥n de venta <strong>al contado</strong>.
        <ul class="mt-2 mb-0">
          {% for f in facturas_descartadas %}
          <li>Folio {{ f['folio'] }} ‚Äî RUT Receptor: {{ f['rut_receptor'] }}</li>
          {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
      {% endif %}
    </div>

    <!-- ‚úÖ Tab: Confirmadas -->
    <div class="tab-pane fade" id="confirmadas" role="tabpanel" aria-labelledby="confirmadas-tab">
      <h5 class="text-success mb-3">‚úÖ Facturas confirmadas</h5>
      <div class="table-responsive mb-5">
        <table class="table table-bordered table-hover bg-white">
          <thead class="table-light">
            <tr>
              <th>Folio</th>
              <th>Emisor</th>
              <th>Receptor</th>
              <th>Monto</th>
              <th>F. Emisi√≥n</th>
              <th>F. Venc.</th>
              <th>Origen</th>
              <th>Estado / Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <p>Total facturas confirmadas en backend: {{ facturas_confirmadas | length }}</p>
            {% for factura in facturas_confirmadas %}
            <tr>
              <td>{{ factura.folio or 'Sin folio' }}</td>
              <td>{{ factura.razon_social_emisor or factura.rut_emisor }}</td>
              <td>{{ factura.razon_social_receptor or factura.rut_receptor or 'N/A' }}</td>
              <td>${{ '{:,.0f}'.format(factura.monto) if factura.monto else '0' }}</td>
              <td>{{ factura.fecha_emision or '___' }}</td>
              <td>{{ factura.fecha_vencimiento or '___' }}</td>
              <td>{{ factura.origen_confirmacion or '___' }}</td>
              <td>
                {{ factura.estado_dte or '---' }}<br>
                {% if factura.estado_dte == "Confirmada por pagador" %}
                <div class="d-grid gap-2 mt-1">
                  <form method="post" action="/proveedor/solicitar_confirming/folio/{{ factura.folio }}">
                    <button class="btn btn-primary btn-sm w-100">Solicitar confirming</button>
                  </form>
                  <form method="post" action="/proveedor/rechazar_vencimiento/folio/{{ factura.folio }}">
                    <button class="btn btn-danger btn-sm w-100">Rechazar vencimiento</button>
                  </form>
                </div>
                {% elif factura.estado_dte == "Confirming solicitado" %}
                  <span class="text-success">Confirming solicitado</span>
                  <a href="/proveedor/ofertas-folio/{{ factura.folio }}" class="btn btn-sm btn-outline-primary ms-2">Ver ofertas</a>
                {% elif factura.estado_dte == "Confirming adjudicado" %}
                  <span class="text-success">Confirming adjudicado</span><br>
                  {% if factura.financiador %}
                    <small class="text-muted">Financiador: {{ factura.financiador.nombre }}</small><br>
                    {% if factura.financiador.fondo %}
                      <small class="text-muted">Fondo: {{ factura.financiador.fondo.nombre }}</small>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">Sin facturas confirmadas.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

<!-- üì¨ Tab: Confirming solicitado -->
<div class="tab-pane fade" id="confirming" role="tabpanel" aria-labelledby="confirming-tab">
  <h5 class="text-primary mb-3">üì¨ Facturas con confirming solicitado</h5>

  {% for factura in facturas_confirming %}
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <strong>Folio:</strong> {{ factura.folio }}<br>
        <strong>Receptor:</strong> {{ factura.razon_social_receptor }}<br>
        <strong>Monto:</strong> ${{ '{:,.0f}'.format(factura.monto) }}
      </div>
      <div>
        <span class="badge bg-warning text-dark">Confirming solicitado</span>
      </div>
    </div>
    <div class="card-body">
      {% set ofertas = ofertas_por_factura.get(factura.folio, []) %}
      {% if ofertas %}
      <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover bg-white">
  <thead class="table-light">
    <tr>
      <th>Financiador</th>
      <th class="text-end">Tasa total mensual (%)</th>
      <th class="text-end">D√≠as</th>
      <th class="text-end">Comisi√≥n ($)</th>
      <th class="text-end">Precio Cesi√≥n ($)</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody>
    {% for oferta in ofertas %}
    {% set tasa_total = ((oferta.tasa_interes or 0) + (oferta.financiador.costo_fondos_mensual or 0)) %}
    <tr>
      <td>{{ oferta.financiador.nombre }}</td>
      <td class="text-end">
        {{ '%.2f' % tasa_total }} %
      </td>
      <td class="text-end">
        {{ oferta.dias_anticipacion if oferta.dias_anticipacion is not none else 'N/D' }}
      </td>
      <td class="text-end">
        ${{ '{:,.0f}'.format(oferta.comision_flat or 0) }}
      </td>
      <td class="text-end">
        {% if oferta.precio_cesion is not none %}
          ${{ '{:,.0f}'.format(oferta.precio_cesion) }}
        {% else %} N/A {% endif %}
      </td>
      <td>
        <form method="post" action="/proveedor/aceptar-oferta/{{ oferta.id }}">
          <button type="submit" class="btn btn-success btn-sm">‚úÖ Adjudicar</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>  
      </div>
      {% else %}
      <p class="text-muted">Sin ofertas a√∫n para esta factura.</p>
      {% endif %}
    </div>
  </div>
  {% else %}
  <p class="text-muted text-center">No hay facturas con confirming solicitado.</p>
  {% endfor %}
</div>

<!-- üèÅ Tab: Confirming adjudicado -->
 <div class="tab-pane fade" id="adjudicadas" role="tabpanel" aria-labelledby="adjudicadas-tab">
  <h5 class="mb-3">üèÅ Facturas con confirming adjudicado</h5>
  <div class="table-responsive">
    <table class="table table-bordered table-hover bg-white">
      <thead class="table-light">
        <tr>
          <th>Folio</th>
          <th>Emisor</th>
          <th>Receptor</th>
          <th>Monto</th>
          <th>F. Emisi√≥n</th>
          <th>F. Venc.</th>
          <th>Financiador</th>
          <th>Fondo</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for f in facturas_adjudicadas %}
        <tr>
          <td>{{ f.folio }}</td>
          <td>{{ f.razon_social_emisor }}</td>
          <td>{{ f.razon_social_receptor }}</td>
          <td>${{ '{:,.0f}'.format(f.monto) }}</td>
          <td>{{ f.fecha_emision }}</td>
          <td>{{ f.fecha_vencimiento }}</td>
          <td>{{ f.financiador.nombre if f.financiador else '-' }}</td>
          <td>{{ f.financiador.fondo.nombre if f.financiador and f.financiador.fondo else '-' }}</td>
          <td><span class="text-success">Confirming adjudicado</span></td>
        </tr>
        {% else %}
        <tr><td colspan="9" class="text-center text-muted">Sin adjudicadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>console.log("üß™ Script cargado");</script>
<script>    
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".solicitar-confirmacion").forEach(button => {
        button.addEventListener("click", function () {
            const folio = this.getAttribute("data-folio");

            fetch(`/proveedor/solicitar_confirmacion/ajax/${folio}`, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Ocultar o eliminar la fila actual (opcional)
                    const fila = this.closest("tr");
                    fila.remove();

                    alert(`‚úÖ Factura ${data.folio} ahora est√° en estado: ${data.nuevo_estado}`);
                    // Aqu√≠ puedes tambi√©n moverla a otra tabla si quieres
                } else {
                    alert("‚ùå No se pudo actualizar la factura.");
                }
            })
            .catch(err => {
                console.error("Error:", err);
                alert("‚ùå Error inesperado.");
            });
        });
    });
});
</script>
{% endblock %}    

