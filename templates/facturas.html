{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Mis Facturas</h2>
        <a href="/proveedor/logout" class="btn btn-outline-secondary">Cerrar sesi√≥n</a>
    </div>

    <!-- Carga desde ZIP / XML -->
    <form action="/proveedor/facturas" method="post" enctype="multipart/form-data" class="mb-4">
        <label class="form-label me-2 fw-semibold">Subir archivo (XML o ZIP):</label>
        <input type="file" name="archivo" accept=".xml,.zip" class="form-control d-inline-block w-auto me-2" required>
        <button class="btn btn-primary">üì§ Cargar</button>
    </form>

    <!-- Importaci√≥n desde SII -->
    <div class="mb-4">
        <form method="GET" action="/proveedor/importar_sii_facturas">
            <button type="submit" class="btn btn-primary" style="font-size: 1rem; padding: 10px 20px;">
                üì• Importar desde SII (√∫ltima descarga)
            </button>
        </form>
        <small class="text-muted ms-2">
            Se cargar√°n las facturas del √∫ltimo JSON descargado desde el portal del SII.
        </small>
    </div>

    <!-- Carga manual colapsable -->
    <p>
        <a class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" href="#collapseManual" role="button">
            ‚ûï Cargar factura manualmente
        </a>
    </p>
    <div class="collapse" id="collapseManual">
        <div class="card card-body mb-4">
            <form action="/proveedor/facturas" method="post" class="row g-3">
                <div class="col-md-2"><label class="form-label">Folio</label><input type="number" name="folio" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">RUT Receptor</label><input type="text" name="rut_receptor" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">Raz√≥n Social Receptor</label><input type="text" name="razon_social_receptor" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">Tipo DTE</label><input type="text" name="tipo_dte" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">Monto</label><input type="number" name="monto" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">F. Emisi√≥n</label><input type="date" name="fecha_emision" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">F. Venc.</label><input type="date" name="fecha_vencimiento" class="form-control" required></div>
                <div class="col-12 text-end"><button class="btn btn-success">Guardar factura</button></div>
            </form>
            <small class="text-muted">*Este formulario es opcional.</small>
        </div>
    </div>

    {% if facturas_descartadas %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Alerta:</strong> Se omitieron {{ facturas_descartadas|length }} factura(s) por tener condici√≥n de venta <strong>al contado</strong>.
        <ul class="mt-2 mb-0">
            {% for f in facturas_descartadas %}
            <li>Folio {{ f['folio'] }} ‚Äî RUT Receptor: {{ f['rut_receptor'] }}</li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    {% endif %}

    <!-- üî∂ Secci√≥n: Facturas pendientes de gesti√≥n -->
    <h5 class="text-primary mt-4 mb-3">üìå Facturas pendientes de gesti√≥n</h5>
    <div class="table-responsive mb-5">
        <table class="table table-bordered table-hover bg-white">
            <thead class="table-light">
                <tr>
                    <th>Folio</th><th>Emisor</th><th>Receptor</th><th>Monto</th>
                    <th>F. Emisi√≥n</th><th>F. Venc.</th><th>Estado / Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
            {% for factura in facturas if factura.estado_dte in ["Cargada", "Confirmaci√≥n solicitada al pagador"] %}
                <tr>
                    <td>{{ factura.folio }}</td>
                    <td>{{ factura.razon_social_emisor }}</td>
                    <td>{{ factura.razon_social_receptor }}</td>
                    <td>${{ '{:,.0f}'.format(factura.monto) }}</td>
                    <td>{{ factura.fecha_emision }}</td>
                    <td>{{ factura.fecha_vencimiento }}</td>
                    <td>
                        {% if factura.estado_dte == "Cargada" %}
                            <form method="get" action="/proveedor/solicitar_confirmacion/folio/{{ factura.folio }}">
                                <button class="btn btn-sm btn-outline-warning">Solicitar confirmaci√≥n</button>
                            </form>
                        {% elif factura.estado_dte == "Confirmaci√≥n solicitada al pagador" %}
                            <span class="badge bg-warning text-dark">Confirmaci√≥n solicitada</span>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="7" class="text-center text-muted">Sin facturas pendientes.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- üü© Secci√≥n: Facturas confirmadas -->
    <h5 class="text-success mb-3">‚úÖ Facturas confirmadas</h5>
    <div class="table-responsive mb-5">
        <table class="table table-bordered table-hover bg-white">
            <thead class="table-light">
                <tr>
                    <th>Folio</th><th>Emisor</th><th>Receptor</th><th>Monto</th>
                    <th>F. Emisi√≥n</th><th>F. Venc.</th><th>Estado / Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
            {% for factura in facturas if factura.estado_dte in ["Confirmada por pagador", "Confirming solicitado", "Confirming adjudicado"] %}
                <tr>
                    <td>{{ factura.folio }}</td>
                    <td>{{ factura.razon_social_emisor }}</td>
                    <td>{{ factura.razon_social_receptor }}</td>
                    <td>${{ '{:,.0f}'.format(factura.monto) }}</td>
                    <td>{{ factura.fecha_emision }}</td>
                    <td>{{ factura.fecha_vencimiento }}</td>
                    <td>
                        {% if factura.estado_dte == "Confirmada por pagador" %}
                            <form method="post" action="/proveedor/solicitar_confirming/folio/{{ factura.folio }}" class="d-inline">
                                <button class="btn btn-sm btn-outline-primary">Solicitar confirming</button>
                            </form>
                            <form method="post" action="/proveedor/rechazar_vencimiento/folio/{{ factura.folio }}" class="d-inline ms-1">
                                <button class="btn btn-sm btn-outline-danger">Rechazar vencimiento</button>
                            </form>
                        {% elif factura.estado_dte == "Confirming solicitado" %}
                            <span class="text-success">Confirming solicitado</span>
                            <a href="/proveedor/ofertas-folio/{{ factura.folio }}" class="btn btn-sm btn-outline-primary ms-2">Ver ofertas</a>
                        {% elif factura.estado_dte == "Confirming adjudicado" %}
                            <span class="text-success">Confirming adjudicado</span><br>
                            {% if factura.financiador %}
                                <small class="text-muted">Financiador: {{ factura.financiador.nombre }}</small>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="7" class="text-center text-muted">Sin facturas confirmadas.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
