{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Mis Facturas</h2>
        <!-- Tabs de navegaci√≥n -->
<ul class="nav nav-tabs mb-4" id="facturasTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab">
      üìå Pendientes
      <span class="badge bg-secondary ms-1">
        {{ facturas | selectattr("estado_dte", "in", ["Confirmaci√≥n solicitada al pagador", "Rechazada por pagador"]) | list | length }}
      </span>
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="cargadas-tab" data-bs-toggle="tab" data-bs-target="#cargadas" type="button" role="tab">
      üìù Cargadas
      <span class="badge bg-secondary ms-1">
        {{ facturas | selectattr("estado_dte", "equalto", "Cargada") | list | length }}
      </span>
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="confirmadas-tab" data-bs-toggle="tab" data-bs-target="#confirmadas" type="button" role="tab">
      ‚úÖ Confirmadas
      <span class="badge bg-secondary ms-1">
        {{ facturas | selectattr("estado_dte", "equalto", "Confirmada por pagador") | list | length }}
      </span>
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="confirming-tab" data-bs-toggle="tab" data-bs-target="#confirming" type="button" role="tab">
      üì¨ Confirming solicitado
      <span class="badge bg-secondary ms-1">
        {{ facturas | selectattr("estado_dte", "equalto", "Confirmaci√≥n solicitada al pagador") | selectattr("confirming_solicitado", "equalto", True) | list | length }}
      </span>
    </button>
  </li>
</ul>
<div class="tab-content" id="facturasTabsContent">

  <!-- üìå Tab: Pendientes -->
  <div class="tab-pane fade show active" id="pendientes" role="tabpanel" aria-labelledby="pendientes-tab">
    <p class="text-muted">Aqu√≠ se mostrar√°n las facturas con estado pendiente (confirmaci√≥n solicitada o rechazadas).</p>
  </div>

    <!-- Carga desde ZIP / XML -->
    <form action="/proveedor/facturas" method="post" enctype="multipart/form-data" class="mb-4">
        <label class="form-label me-2 fw-semibold">Subir archivo (XML o ZIP):</label>
        <input type="file" name="archivo" accept=".xml,.zip" class="form-control d-inline-block w-auto me-2" required>
        <button class="btn btn-primary">üì§ Cargar</button>
    </form>

    <!-- Importaci√≥n desde SII -->
    <div class="mb-4">
        <form method="GET" action="/proveedor/importar_sii_facturas">
            <button type="submit" class="btn btn-primary" style="font-size: 1rem; padding: 10px 20px;">
                üì• Importar desde SII (√∫ltima descarga)
            </button>
        </form>
        <small class="text-muted ms-2">
            Se cargar√°n las facturas del √∫ltimo JSON descargado desde el portal del SII.
        </small>
    </div>

    <!-- Carga manual colapsable -->
    <p>
        <a class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" href="#collapseManual" role="button">
            ‚ûï Cargar factura manualmente
        </a>
    </p>
    <div class="collapse" id="collapseManual">
        <div class="card card-body mb-4">
            <form action="/proveedor/facturas" method="post" class="row g-3">
                <div class="col-md-2"><label class="form-label">Folio</label><input type="number" name="folio" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">RUT Receptor</label><input type="text" name="rut_receptor" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">Raz√≥n Social Receptor</label><input type="text" name="razon_social_receptor" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">Tipo DTE</label><input type="text" name="tipo_dte" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">Monto</label><input type="number" name="monto" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">F. Emisi√≥n</label><input type="date" name="fecha_emision" class="form-control" required></div>
                <div class="col-md-2"><label class="form-label">F. Venc.</label><input type="date" name="fecha_vencimiento" class="form-control" required></div>
                <div class="col-12 text-end"><button class="btn btn-success">Guardar factura</button></div>
            </form>
            <small class="text-muted">*Este formulario es opcional.</small>
        </div>
    </div>
    <!-- üî∂ Secci√≥n: Facturas pendientes de gesti√≥n -->
    <h5 class="text-warning mb-3">üìå Facturas pendientes</h5>
<div class="table-responsive mb-5">
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-light">
            <tr>
                <th>Folio</th>
                <th>Emisor</th>
                <th>Receptor</th>
                <th>Monto</th>
                <th>F. Emisi√≥n</th>
                <th>F. Venc.</th>
                <th>Origen</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
        {% for factura in facturas if factura.estado_dte in ["Confirmaci√≥n solicitada al pagador", "Rechazada por pagador"] %}
            <tr>
                <td>{{ factura.folio }}</td>
                <td>{{ factura.razon_social_emisor }}</td>
                <td>{{ factura.razon_social_receptor }}</td>
                <td>${{ '{:,.0f}'.format(factura.monto) }}</td>
                <td>{{ factura.fecha_emision }}</td>
                <td>{{ factura.fecha_vencimiento }}</td>
                <td>{{ factura.origen_confirmacion or "Desconocido" }}</td>
                <td>
                    {% if factura.estado_dte == "Confirmaci√≥n solicitada al pagador" %}
                        <span class="text-info">Confirmaci√≥n solicitada</span>
                    {% elif factura.estado_dte == "Rechazada por pagador" %}
                        <span class="text-danger">Rechazada por pagador</span>
                    {% endif %}
                </td>
            </tr>
        {% else %}
            <tr><td colspan="8" class="text-center text-muted">Sin facturas pendientes.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

    {% if facturas_descartadas %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Alerta:</strong> Se omitieron {{ facturas_descartadas|length }} factura(s) por tener condici√≥n de venta <strong>al contado</strong>.
        <ul class="mt-2 mb-0">
            {% for f in facturas_descartadas %}
            <li>Folio {{ f['folio'] }} ‚Äî RUT Receptor: {{ f['rut_receptor'] }}</li>
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    {% endif %}
  </div>

  <!-- üìù Tab: Cargadas -->
  <div class="tab-pane fade" id="cargadas" role="tabpanel" aria-labelledby="cargadas-tab">
    <!-- üü® Secci√≥n: Facturas cargadas que permiten solicitar confirmaci√≥n -->
<h5 class="text-primary mb-3">üìù Facturas cargadas (puede solicitar confirmaci√≥n)</h5>
<div class="table-responsive mb-5">
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-light">
            <tr>
                <th>Folio</th>
                <th>Emisor</th>
                <th>Receptor</th>
                <th>Monto</th>
                <th>F. Emisi√≥n</th>
                <th>F. Venc.</th>
                <th>Origen</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
        {% for factura in facturas if factura.estado_dte == "Cargada" %}
            <tr>
                <td>{{ factura.folio }}</td>
                <td>{{ factura.razon_social_emisor }}</td>
                <td>{{ factura.razon_social_receptor }}</td>
                <td>${{ '{:,.0f}'.format(factura.monto) }}</td>
                <td>{{ factura.fecha_emision }}</td>
                <td>{{ factura.fecha_vencimiento }}</td>
                <td>{{ factura.origen_confirmacion or "Desconocido" }}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="solicitarConfirmacion({{ factura.folio }})">
                        Solicitar confirmaci√≥n
                    </button>
                </td>
            </tr>
        {% else %}
            <tr><td colspan="8" class="text-center text-muted">Sin facturas cargadas para gestionar.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
    </div>


  <!-- ‚úÖ Tab: Confirmadas -->
  <div class="tab-pane fade" id="confirmadas" role="tabpanel" aria-labelledby="confirmadas-tab">
    <!-- üü© Secci√≥n: Facturas confirmadas -->
<h5 class="text-success mb-3">‚úÖ Facturas confirmadas</h5>
<div class="table-responsive mb-5">
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-light">
            <tr>
                <th>Folio</th>
                <th>Emisor</th>
                <th>Receptor</th>
                <th>Monto</th>
                <th>F. Emisi√≥n</th>
                <th>F. Venc.</th>
                <th>Origen</th>
                <th>Estado / Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
        <p>Total facturas confirmadas en backend: {{ facturas_confirmadas | length }}</p>
        {% for factura in facturas if factura.estado_dte == "Confirmada por pagador" %}
            <tr>
                <td>{{ factura.folio or 'Sin folio'}}</td>
                <td>{{ factura.razon_social_emisor or factura.rut_emisor}}</td>
                <td>{{ factura.razon_social_receptor or factura.rut_receptor or 'N/A'}}</td>
                <td>${{ '{:,.0f}'.format(factura.monto) if factura.monto else '0'}}</td>
                <td>{{ factura.fecha_emision or '___'}}</td>
                <td>{{ factura.fecha_vencimiento or '___'}}</td>
                <td>{{ factura.origen_confirmacion or '___' }}</td>
                <td>
                    {{ factura.estado_dte or '---' }}<br>
                    {% if factura.estado_dte == "Confirmada por pagador" %}
                        <div class="d-grid gap-2 mt-1">
                            <form method="post" action="/proveedor/solicitar_confirming/folio/{{ factura.folio }}">
                                <button class="btn btn-primary btn-sm w-100">Solicitar confirming</button>
                            </form>
                            <form method="post" action="/proveedor/rechazar_vencimiento/folio/{{ factura.folio }}">
                                <button class="btn btn-danger btn-sm w-100">Rechazar vencimiento</button>
                            </form>
                        </div>
                    {% elif factura.estado_dte == "Confirming solicitado" %}
                        <span class="text-success">Confirming solicitado</span>
                        <a href="/proveedor/ofertas-folio/{{ factura.folio }}" class="btn btn-sm btn-outline-primary ms-2">Ver ofertas</a>
                    {% elif factura.estado_dte == "Confirming adjudicado" %}
                        <span class="text-success">Confirming adjudicado</span><br>
                        {% if factura.financiador %}
                            <small class="text-muted">Financiador: {{ factura.financiador.nombre }}</small><br>
                            {% if factura.financiador.fondo %}
                                <small class="text-muted">Fondo: {{ factura.financiador.fondo.nombre }}</small>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% else %}
            <tr><td colspan="8" class="text-center text-muted">Sin facturas confirmadas.</td></tr>
        {% endfor %}
    <script>
function solicitarConfirmacion(folio) {
    fetch(`/proveedor/solicitar_confirmacion/folio/${folio}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            alert(`‚úÖ Confirmaci√≥n solicitada para folio ${folio}`);
            location.reload();
        } else {
            alert("‚ùå Error al solicitar confirmaci√≥n.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("‚ùå Error inesperado.");
    });
}
</script>    
    
    </tbody>
    </table>
</div>
  </div>

  <!-- üì¨ Tab: Confirming solicitado -->
  <div class="tab-pane fade" id="confirming" role="tabpanel" aria-labelledby="confirming-tab">
    <!-- üîµ Secci√≥n: Confirming solicitado -->
<h5 class="text-primary mb-3">üì¨ Facturas con confirming solicitado</h5>
<div class="table-responsive mb-5">
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-light">
            <tr>
                <th>Folio</th>
                <th>Emisor</th>
                <th>Receptor</th>
                <th>Monto</th>
                <th>F. Emisi√≥n</th>
                <th>F. Venc.</th>
                <th>Origen</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
        {% for factura in facturas if factura.estado_dte == "Confirmaci√≥n solicitada al pagador" %}
            <tr>
                <td>{{ factura.folio }}</td>
                <td>{{ factura.razon_social_emisor }}</td>
                <td>{{ factura.razon_social_receptor }}</td>
                <td>${{ '{:,.0f}'.format(factura.monto) }}</td>
                <td>{{ factura.fecha_emision }}</td>
                <td>{{ factura.fecha_vencimiento }}</td>
                <td>{{ factura.origen_confirmacion }}</td>
                <td><span class="text-info">Confirming solicitado</span></td>
            </tr>
        {% else %}
            <tr><td colspan="8" class="text-center text-muted">Sin facturas en confirming solicitado.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>  
</div>
{% endblock %}

    




 