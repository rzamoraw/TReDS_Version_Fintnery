{% extends "base.html" %}
{% block content %}
<style>
  .chart-sm { max-height: 130px; }
  .chart-md { max-height: 160px; }
</style>

<div class="container mt-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Ficha 360º del Pagador</h3>
    <a class="btn btn-outline-secondary" href="javascript:history.back()">Volver</a>
  </div>

  <!-- Identidad -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <div>
          <h5 class="mb-1">{{ perfil.razon_social or "(Razón social no registrada)" }}</h5>
          <div class="text-muted">RUT: <strong>{{ rut }}</strong></div>
          {% if perfil.nombre_fantasia %}<div class="text-muted">Nombre Fantasía: {{ perfil.nombre_fantasia }}</div>{% endif %}
          {% if perfil.sector_ciiu %}<div class="text-muted">Sector CIIU: {{ perfil.sector_ciiu }}</div>{% endif %}
          {% if perfil.sitio_web %}<div class="text-muted">Web: <a href="{{ perfil.sitio_web }}" target="_blank">{{ perfil.sitio_web }}</a></div>{% endif %}
        </div>
        <div class="text-end">
          {% if perfil.email_tesoreria %}<div class="mb-1">Tesorería: <a href="mailto:{{ perfil.email_tesoreria }}">{{ perfil.email_tesoreria }}</a></div>{% endif %}
          {% if perfil.telefono %}<div>Tel: {{ perfil.telefono }}</div>{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">Total facturas</div>
        <div class="fs-4 fw-bold">{{ kpis.totales.total or 0 }}</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">Confirmadas / adjudicadas</div>
        <div class="fs-4 fw-bold">{{ kpis.totales.confirmadas or 0 }}</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">Tasa confirmación</div>
        <div class="fs-4 fw-bold">{{ "%.1f"|format(kpis.totales.confirmacion_rate or 0.0) }}%</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">TMC (días)</div>
        <div class="fs-4 fw-bold">{{ kpis.tiempos.tiempo_medio_confirmacion or "—" }}</div>
      </div></div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-2">Confirmadas vs Rechazadas vs Pendientes</h6>
        <canvas id="pieConfirm" height="200"></canvas>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-2">TMC por mes (días)</h6>
        <canvas id="lineTMC" height="200"></canvas>
      </div></div>
    </div>
  </div>

  <div class="card mb-4">
  <!-- altura total del card compacta -->
  <div class="card-body" style="height: 180px;">
    <h6 class="mb-2">Monto confirmado por mes</h6>
    <!-- contenedor con altura fija para el canvas -->
    <div style="height: 120px;">
      <canvas id="barMontos" class="w-100 h-100"></canvas>
    </div>
  </div>
</div>

  <!-- ESG -->
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="mb-3">
        ESG & Certificaciones
        {% if esg_api and esg_api.certificaciones and esg_api.certificaciones|length > 0 %}
            <span class="badge text-bg-info ms-2">Incluye datos de API</span>
        {% endif %}
      </h6>
      {% if certs and certs|length > 0 %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr><th>Certificación</th><th>Emisor</th><th>Válido hasta</th><th>Enlace</th></tr></thead>
          <tbody>
            {% for c in certs %}
            <tr>
              <td>{{ c.tipo }}</td>
              <td>{{ c.emisor or "—" }}</td>
              <td>{{ c.valido_hasta or "—" }}</td>
              <td>{% if c.enlace %}<a href="{{ c.enlace }}" target="_blank">Ver</a>{% else %}—{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-muted">Sin certificaciones registradas.</div>
      {% endif %}
    </div>
  </div>

  <!-- Mercado Público -->
  <div class="card mb-4">
    <div class="card-body">
      <!-- Título + badge -->
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-0">Mercado Público</h6>
          <small class="text-muted">
            RUT consultado: {{ (mp and mp.get('rut_consultado')) or rut }}
          </small>
        </div>
        {% if mp and mp.get('encontrado') %}
          <span class="badge text-bg-success">Proveedor registrado</span>
        {% else %}
          <span class="badge text-bg-secondary">No aparece en MP</span>
        {% endif %}
      </div>

      <!-- Acciones -->
      <div class="mt-2 d-flex gap-2">
        <a class="btn btn-sm btn-outline-dark"
           href="/pagador/ext/mercado-publico/{{ rut }}"
           target="_blank" rel="noopener">Ver JSON (API)</a>
        <a class="btn btn-sm btn-outline-secondary"
           href="https://www.google.com/search?q=site%3Amercadopublico.cl+%22{{ ((mp and mp.get('rut_consultado')) or rut)|urlencode }}%22"
           target="_blank" rel="noopener">Buscar en Google (MP)</a>
        <a class="btn btn-sm btn-outline-primary"
           href="/pagador/ext/mercado-publico/{{ rut }}?force=1"
           target="_blank" rel="noopener">Refrescar datos (API)</a>
      </div>

      <hr class="mt-3 mb-3"/>

      {# Normalizar estructuras para que nunca rompa si falta algo #}
      {% set oc_res    = (mp_oc  and mp_oc.get('resumen'))  or {} %}
      {% set oc_items  = (mp_oc  and mp_oc.get('items'))    or [] %}
      {% set adj_res   = (mp_adj and mp_adj.get('resumen')) or {} %}
      {% set adj_items = (mp_adj and mp_adj.get('items'))   or [] %}

      <div class="row">
        <div class="col-md-6">
          <div><strong>Código Empresa:</strong> {{ (mp and mp.get('codigo_empresa')) or "—" }}</div>
          <div><strong>Nombre Empresa:</strong> {{ (mp and mp.get('nombre_empresa')) or "—" }}</div>
        </div>
        <div class="col-md-6">
          <div class="mb-1">
            <strong>OC recientes:</strong> {{ oc_res.get('cantidad', 0) }}
            &nbsp;|&nbsp;
            <strong>Neto total (muestra):</strong>
            ${{ "{:,.0f}".format(oc_res.get('monto_neto_total', 0)) }}
          </div>
          <div>
            <strong>Adjudicaciones:</strong> {{ adj_res.get('cantidad', 0) }}
            &nbsp;|&nbsp;
            <strong>Monto adjudicado (muestra):</strong>
            ${{ "{:,.0f}".format(adj_res.get('monto_adjudicado_total', 0)) }}
          </div>
        </div>
      </div>

      {% if oc_items|length > 0 %}
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-secondary" type="button"
                  data-bs-toggle="collapse" data-bs-target="#ocCollapse">
            Ver detalle Órdenes de Compra
          </button>
          <div class="collapse mt-2" id="ocCollapse">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th># OC</th>
                    <th>Fecha</th>
                    <th>Comprador</th>
                    <th class="text-end">Monto Neto</th>
                  </tr>
                </thead>
                <tbody>
                  {% for it in oc_items %}
                    {% set v = (it.get('MontoNeto') or it.get('Monto') or 0) | float %}
                    <tr>
                      <td>{{ it.get('NumeroOC') or it.get('CodigoOC') or "—" }}</td>
                      <td>{{ it.get('FechaCreacion') or it.get('Fecha') or "—" }}</td>
                      <td>
                        {% set comp = it.get('Comprador') %}
                        {{ (comp and (comp.get('Nombre') or comp)) or "—" }}
                      </td>
                      <td class="text-end">${{ "{:,.0f}".format(v) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}

      {% if adj_items|length > 0 %}
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-secondary" type="button"
                  data-bs-toggle="collapse" data-bs-target="#adjCollapse">
            Ver detalle Adjudicaciones
          </button>
          <div class="collapse mt-2" id="adjCollapse">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Cód. Licitación</th>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Comprador</th>
                    <th class="text-end">Monto Adjudicado</th>
                  </tr>
                </thead>
                <tbody>
                  {% for it in adj_items %}
                    {% set v = (it.get('MontoAdjudicado') or it.get('Monto') or 0) | float %}
                    <tr>
                      <td>{{ it.get('CodigoLicitacion') or "—" }}</td>
                      <td>{{ it.get('Nombre') or "—" }}</td>
                      <td>{{ it.get('FechaAdjudicacion') or it.get('Fecha') or "—" }}</td>
                      <td>
                        {% set comp = it.get('Comprador') %}
                        {{ (comp and (comp.get('Nombre') or comp)) or "—" }}
                      </td>
                      <td class="text-end">${{ "{:,.0f}".format(v) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Facturas recientes -->
  <div class="card mb-5">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Últimas 10 facturas</h6>
        <a class="btn btn-sm btn-primary" href="/financiador/marketplace?rut_pagador={{ rut }}">Ver en marketplace</a>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Folio</th><th>Emisor</th><th>Emisión</th><th>Vencimiento</th><th>Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for f in recientes %}
            <tr>
              <td>{{ f.folio }}</td>
              <td>{{ f.razon_social_emisor or f.rut_emisor }}</td>
              <td>{{ f.fecha_emision or "—" }}</td>
              <td>{{ f.fecha_vencimiento or "—" }}</td>
              <td>
                {% set ev = (f.estado_vista or f.estado_confirmacion or "Pendiente") %}
                <span class="badge
                  {% if ev.lower().startswith('adjudic') %} bg-success
                  {% elif ev.lower().startswith('confirming') %} bg-info
                  {% elif ev.lower() == 'rechazada' %} bg-danger
                  {% else %} bg-secondary {% endif %}">
                  {{ ev }}
                </span>
              </td>
            </tr>
            {% endfor %}
            {% if recientes|length == 0 %}
            <tr><td colspan="5" class="text-muted">Sin registros.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Totales
  const confirmadas = {{ kpis.totales.confirmadas or 0 }};
  const rechazadas  = {{ kpis.totales.rechazadas  or 0 }};
  const pendientes  = {{ kpis.totales.pendientes  or 0 }};

  // Pie
  new Chart(document.getElementById('pieConfirm'), {
    type: 'pie',
    data: {
      labels: ['Confirmadas/Adjudicadas','Rechazadas','Pendientes'],
      datasets: [{ data: [confirmadas, rechazadas, pendientes] }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // Series desde el router
  const tmcLabels   = {{ tmc_labels_json   | safe }};
  const tmcData     = {{ tmc_data_json     | safe }};
  const montoLabels = {{ monto_labels_json | safe }};
  const montoData   = {{ monto_data_json   | safe }};

  // Línea TMC
  new Chart(document.getElementById('lineTMC'), {
    type: 'line',
    data: { labels: tmcLabels, datasets: [{ label: 'TMC (días)', data: tmcData }] },
    options: { responsive: true }
  });

  // Barras montos
  new Chart(document.getElementById('barMontos'), {
    type: 'bar',
    data: { labels: montoLabels, datasets: [{ label: 'Monto confirmado', data: montoData, maxBarThickness: 18 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,         // << clave para respetar el alto del contenedor
      plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { callback: (v) => Intl.NumberFormat('es-CL').format(v) } },
        x: { grid: { display: false } }
      }
    }
  });
</script>
{% endblock %}