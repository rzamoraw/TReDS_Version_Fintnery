{% extends "base.html" %}
{% block content %}
<style>
  .chart-sm { max-height: 130px; }
  .chart-md { max-height: 160px; }
</style>

<div class="container mt-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Ficha 360º del Pagador</h3>
    <a class="btn btn-outline-secondary" href="javascript:history.back()">Volver</a>
  </div>

  <!-- Identidad -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <div>
          <h5 class="mb-1">{{ perfil.razon_social or mp.razon_social or mp.nombre_fantasia or "(Razón social no registrada)" }}</h5>
          <div class="text-muted">RUT: <strong>{{ rut }}</strong></div>
          {% if perfil.nombre_fantasia %}<div class="text-muted">Nombre Fantasía: {{ perfil.nombre_fantasia }}</div>{% endif %}
          {% if perfil.sector_ciiu %}<div class="text-muted">Sector CIIU: {{ perfil.sector_ciiu }}</div>{% endif %}
          {% if perfil.sitio_web %}<div class="text-muted">Web: <a href="{{ perfil.sitio_web }}" target="_blank">{{ perfil.sitio_web }}</a></div>{% endif %}
        </div>
        <div class="text-end">
          {% if perfil.email_tesoreria %}<div class="mb-1">Tesorería: <a href="mailto:{{ perfil.email_tesoreria }}">{{ perfil.email_tesoreria }}</a></div>{% endif %}
          {% if perfil.telefono %}<div>Tel: {{ perfil.telefono }}</div>{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">Total facturas</div>
        <div class="fs-4 fw-bold">{{ kpis.totales.total or 0 }}</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">Confirmadas / adjudicadas</div>
        <div class="fs-4 fw-bold">{{ kpis.totales.confirmadas or 0 }}</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">Tasa confirmación</div>
        <div class="fs-4 fw-bold">{{ "%.1f"|format(kpis.totales.confirmacion_rate or 0.0) }}%</div>
      </div></div>
    </div>
    <div class="col-md-3">
      <div class="card h-100"><div class="card-body">
        <div class="text-muted">TMC (días)</div>
        <div class="fs-4 fw-bold">{{ kpis.tiempos.tiempo_medio_confirmacion or "—" }}</div>
      </div></div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-2">Confirmadas vs Rechazadas vs Pendientes</h6>
        <canvas id="pieConfirm" height="200"></canvas>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-2">TMC por mes (días)</h6>
        <canvas id="lineTMC" height="200"></canvas>
      </div></div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body" style="height: 180px;">
      <h6 class="mb-2">Monto confirmado por mes</h6>
      <div style="height: 120px;">
        <canvas id="barMontos" class="w-100 h-100"></canvas>
      </div>
    </div>
  </div>

<!-- ESG (solo certificaciones BD, sin API externa) -->
<div class="card mb-4">
  <div class="card-body">
    <h6 class="mb-3">ESG & Certificaciones</h6>
    {% if certs and certs|length > 0 %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr><th>Certificación</th><th>Emisor</th><th>Válido hasta</th><th>Enlace</th></tr>
        </thead>
        <tbody>
          {% for c in certs %}
          <tr>
            <td>{{ c.tipo }}</td>
            <td>{{ c.emisor or "—" }}</td>
            <td>{{ c.valido_hasta or "—" }}</td>
            <td>{% if c.enlace %}<a href="{{ c.enlace }}" target="_blank">Ver</a>{% else %}—{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-muted">Sin certificaciones registradas.</div>
    {% endif %}

    {# === RETC dentro de la misma card ESG === #}
    {% set retc = esg_retc or {} %}
    {% if retc.ok and retc.matches and retc.matches|length > 0 %}
      <hr class="my-3"/>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">
          <strong>RETC — Establecimientos</strong>
          <small class="ms-1">({{ retc.total }} resultados)</small>
        </div>
        {% if retc.evidencia_url %}
          <a href="{{ retc.evidencia_url }}" target="_blank" rel="noopener"
             class="btn btn-sm btn-outline-secondary">
            Fuente RETC
          </a>
        {% endif %}
      </div>

      <div class="alert alert-secondary py-2 px-3 d-flex justify-content-between align-items-center">
        <div class="small">
          <strong>{{ retc.year_label }}</strong> —
          CO₂: {{ retc.sum.co2 }} t/año ·
          NOx: {{ retc.sum.nox }} t/año ·
          SO₂: {{ retc.sum.so2 }} t/año ·
          MP: {{ retc.sum.mp }} t/año ·
          Res. Pelig.: {{ retc.sum.res_pelig }} t/año ·
          Res. No Pelig.: {{ retc.sum.res_no_pelig }} t/año
          <small class="text-muted"> ({{ retc.count }} est.)</small>
        </div>
        <button class="btn btn-sm btn-outline-secondary" type="button"
                data-bs-toggle="collapse" data-bs-target="#retcEstab">
          Ver detalle establecimientos
        </button>
      </div>

      <div id="retcEstab" class="collapse">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>RUT</th>
                <th>Razón social</th>
                <th>Establecimiento</th>
                <th>Comuna</th>
                <th>Región</th>
                <th>Rubro</th>
              </tr>
            </thead>
            <tbody>
              {% for it in retc.matches %}
              <tr>
                <td>{{ it.rut or rut }}</td>
                <td>{{ it.razon_social or perfil.razon_social }}</td>
                <td>{{ it.establecimiento or "—" }}</td>
                <td>{{ it.comuna or "—" }}</td>
                <td>{{ it.region or "—" }}</td>
                <td>{{ it.rubro or "—" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div> <!-- fin card-body -->
</div>   <!-- fin card ESG -->

{# --- SNIFA (SMA) — resumen fiscalizaciones / sanciones --- #}
{% set _snifa = snifa or {} %}
<div class="mt-3 border-top pt-3">
  <div class="d-flex align-items-center justify-content-between">
    <h6 class="mb-0">SNIFA (SMA) — Fiscalizaciones y Sanciones</h6>
    <div class="d-flex gap-2">
      {% if _snifa.evidencias and _snifa.evidencias.fiscalizaciones %}
        <a class="btn btn-sm btn-outline-secondary" href="{{ _snifa.evidencias.fiscalizaciones }}" target="_blank" rel="noopener">Dataset Fiscalizaciones</a>
      {% endif %}
      {% if _snifa.evidencias and _snifa.evidencias.sancionatorios %}
        <a class="btn btn-sm btn-outline-secondary" href="{{ _snifa.evidencias.sancionatorios }}" target="_blank" rel="noopener">Dataset Sancionatorios</a>
      {% endif %}
      {% if _snifa.evidencias and _snifa.evidencias.sanciones_firmes %}
        <a class="btn btn-sm btn-outline-secondary" href="{{ _snifa.evidencias.sanciones_firmes }}" target="_blank" rel="noopener">Dataset Sanciones Firmes</a>
      {% endif %}
    </div>
  </div>

  {% set cnt = _snifa.counters or {} %}
  <div class="mt-2 d-flex flex-wrap gap-2">
    <span class="badge text-bg-primary">
      Fiscalizaciones: {{ cnt.fiscalizaciones or 0 }}
    </span>
    <span class="badge text-bg-warning text-dark">
      Proc. sancionatorios activos: {{ cnt.sancionatorios_activos or 0 }}
    </span>
    <span class="badge text-bg-danger">
      Sanciones firmes: {{ cnt.sanciones_firmes or 0 }}
    </span>
  </div>

  {# Detalles colapsables (muestras) #}
  {% set m = _snifa.muestras or {} %}
  <div class="mt-2 d-flex flex-wrap gap-2">
    {% if m.fiscalizaciones and m.fiscalizaciones|length > 0 %}
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#snifaFis">Ver fiscalizaciones</button>
    {% endif %}
    {% if m.sancionatorios and m.sancionatorios|length > 0 %}
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#snifaSan">Ver proc. sancionatorios</button>
    {% endif %}
    {% if m.sanciones_firmes and m.sanciones_firmes|length > 0 %}
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#snifaFirmes">Ver sanciones firmes</button>
    {% endif %}
  </div>

  {% if m.fiscalizaciones and m.fiscalizaciones|length > 0 %}
  <div id="snifaFis" class="collapse mt-2">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr><th>Fecha</th><th>RUT</th><th>Razón social</th><th>Unidad</th><th>Comuna</th><th>Región</th><th>Estado</th><th>Código</th></tr>
        </thead>
        <tbody>
          {% for r in m.fiscalizaciones %}
          <tr>
            <td>{{ r.fecha or "—" }}</td>
            <td>{{ r.rut or rut }}</td>
            <td>{{ r.razon_social or perfil.razon_social }}</td>
            <td>{{ r.unidad or "—" }}</td>
            <td>{{ r.comuna or "—" }}</td>
            <td>{{ r.region or "—" }}</td>
            <td>{{ r.estado or "—" }}</td>
            <td>{{ r.codigo or "—" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if m.sancionatorios and m.sancionatorios|length > 0 %}
  <div id="snifaSan" class="collapse mt-2">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr><th>Fecha</th><th>RUT</th><th>Razón social</th><th>Unidad</th><th>Comuna</th><th>Región</th><th>Estado</th><th>Código</th></tr>
        </thead>
        <tbody>
          {% for r in m.sancionatorios %}
          <tr>
            <td>{{ r.fecha or "—" }}</td>
            <td>{{ r.rut or rut }}</td>
            <td>{{ r.razon_social or perfil.razon_social }}</td>
            <td>{{ r.unidad or "—" }}</td>
            <td>{{ r.comuna or "—" }}</td>
            <td>{{ r.region or "—" }}</td>
            <td>{{ r.estado or "—" }}</td>
            <td>{{ r.codigo or "—" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if m.sanciones_firmes and m.sanciones_firmes|length > 0 %}
  <div id="snifaFirmes" class="collapse mt-2">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr><th>Fecha</th><th>RUT</th><th>Razón social</th><th>Unidad</th><th>Comuna</th><th>Región</th><th>Estado</th><th>Código</th></tr>
        </thead>
        <tbody>
          {% for r in m.sanciones_firmes %}
          <tr>
            <td>{{ r.fecha or "—" }}</td>
            <td>{{ r.rut or rut }}</td>
            <td>{{ r.razon_social or perfil.razon_social }}</td>
            <td>{{ r.unidad or "—" }}</td>
            <td>{{ r.comuna or "—" }}</td>
            <td>{{ r.region or "—" }}</td>
            <td>{{ r.estado or "—" }}</td>
            <td>{{ r.codigo or "—" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>

  {# ====== MERCADO PÚBLICO (card única, con sellos adentro) ====== #}
  <div class="card mb-4">
    <div class="card-body">

      {# Normalizaciones y defensas #}
      {% set _mp       = mp or {} %}
      {% set _is_map   = (_mp is mapping) %}
      {% set sellos    = (_is_map and (_mp.sellos or [])) or [] %}
      {% set is_reg    = (_is_map and (_mp.registrado or (sellos|length > 0))) %}
      {% set hab_raw   = _is_map and _mp.habilitado %}
      {% set rango     = (_is_map and (_mp.rango or None)) or (mp_ventas and mp_ventas.rango) %}
      {% set ventas12  = (_is_map and (_mp.ventas_12m or 0)) or (mp_ventas and (mp_ventas.ventas_mp_ultimo_anio or 0)) or 0 %}

      {# Derivados limpios #}
      {% set entcode = (
          _is_map and (
            _mp.entCode
            or (sellos and (sellos[0].entCode if sellos[0] is mapping else None))
            or _mp.get('codigo_empresa')
          )
        ) or None %}

      {% set nombre_emp = (
          _is_map and (
            _mp.razon_social
            or _mp.nombre_fantasia
            or _mp.get('nombre_empresa')
          )
        ) or None %}

      {% set score = (
          _is_map and (
            (_mp.get('score') if _mp.get('score') is not none else None)
            or (_mp.get('score_promedio') if _mp.get('score_promedio') is not none else None)
          )
        ) %}

      <!-- Título + sellos + badges + rango -->
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-0">Mercado Público</h6>
          <small class="text-muted">RUT consultado: {{ rut }}</small>
        </div>

        <div class="d-flex align-items-center gap-2">
          {% for s in sellos %}
            <span class="badge bg-success">
              {{ s.valor or ('Sello ' ~ (s.tipoSello or '')) }}
            </span>
          {% endfor %}

          {% if _is_map %}
            {% if is_reg %}
              <span class="badge text-bg-success">Proveedor registrado</span>
            {% else %}
              <span class="badge text-bg-secondary">No registrado</span>
            {% endif %}

            {% if hab_raw is not none %}
              {% if hab_raw %}
                <span class="badge text-bg-primary">Habilitada para ofertar</span>
              {% else %}
                <span class="badge text-bg-warning text-dark">No habilitada</span>
              {% endif %}
            {% endif %}
          {% else %}
            <span class="badge text-bg-secondary">Sin datos</span>
          {% endif %}

          {% if mp_ventas and mp_ventas.ok and mp_ventas.rango %}
            <small class="text-muted ms-2">
              Rango: {{ mp_ventas.rango.agno1 or "—" }}-{{ "%02d"|format(mp_ventas.rango.nroMes1 or 0) }}
              → {{ mp_ventas.rango.agno2 or "—" }}-{{ "%02d"|format(mp_ventas.rango.nroMes2 or 0) }}
            </small>
          {% elif rango %}
            <small class="text-muted ms-2">
              Rango: {{ rango.agno1 or "—" }}-{{ "%02d"|format(rango.nroMes1 or 0) }}
              → {{ rango.agno2 or "—" }}-{{ "%02d"|format(rango.nroMes2 or 0) }}
            </small>
          {% endif %}
        </div>
      </div>

      <!-- Acciones -->
      <div class="mt-2 d-flex gap-2">
        <a class="btn btn-sm btn-outline-dark"
           href="/pagador/ext/mercado-publico/{{ rut }}"
           target="_blank" rel="noopener">Ver JSON (API)</a>
        <a class="btn btn-sm btn-outline-secondary"
           href="https://www.google.com/search?q=site%3Amercadopublico.cl+%22{{ rut|urlencode }}%22"
           target="_blank" rel="noopener">Buscar en Google (MP)</a>
        <a class="btn btn-sm btn-outline-primary"
           href="/pagador/ext/mercado-publico/{{ rut }}?force=1"
           target="_blank" rel="noopener">Refrescar datos (API)</a>
      </div>

      <hr class="mt-3 mb-3"/>

      <!-- Resumen identificación + score + ventas -->
      <div class="row mb-2">
        <div class="col-md-6">
          <div><strong>Código Empresa:</strong> {{ entcode or "—" }}</div>
          <div><strong>Nombre Empresa:</strong> {{ nombre_emp or "(sin nombre en MP)" }}</div>
          <div>
            <strong>Score contractual:</strong>
            {% if score is not none %} {{ "%.1f"|format(score) }}/5 {% else %} —/5 {% endif %}
          </div>
          <div>
            <strong>Habilidad MP:</strong>
            {% if hab_raw is none %} —
            {% elif hab_raw %} HABIL
            {% else %} NO HABIL
            {% endif %}
          </div>
        </div>

        <div class="col-md-6">
          <div class="fs-6 fw-semibold">
            Ventas últimos 12 meses: ${{ "{:,.0f}".format(ventas12) }}
            {% if rango %}
              <small class="text-muted ms-1">
                ({{ rango.agno1 or "—" }}-{{ "%02d"|format(rango.nroMes1 or 0) }}
                → {{ rango.agno2 or "—" }}-{{ "%02d"|format(rango.nroMes2 or 0) }})
              </small>
            {% endif %}
          </div>
        </div>
      </div>

      {% set oc_res    = (mp_oc  and mp_oc.get('resumen'))  or {} %}
      {% set oc_items  = (mp_oc  and mp_oc.get('items'))    or [] %}
      {% set adj_res   = (mp_adj and mp_adj.get('resumen')) or {} %}
      {% set adj_items = (mp_adj and mp_adj.get('items'))   or [] %}

      <div class="row">
        <div class="col-md-6">
          <div class="mb-1">
            <strong>OC recientes:</strong> {{ oc_res.get('cantidad', 0) }}
            &nbsp;|&nbsp;
            <strong>Neto total (muestra):</strong>
            ${{ "{:,.0f}".format(oc_res.get('monto_neto_total', 0)) }}
          </div>
          {% if oc_items|length > 0 %}
            <button class="btn btn-sm btn-outline-secondary" type="button"
                    data-bs-toggle="collapse" data-bs-target="#ocCollapse">
              Ver detalle Órdenes de Compra
            </button>
            <div class="collapse mt-2" id="ocCollapse">
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th># OC</th>
                      <th>Fecha</th>
                      <th>Comprador</th>
                      <th class="text-end">Monto Neto</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for it in oc_items %}
                      {% set v = (it.get('MontoNeto') or it.get('Monto') or 0) | float %}
                      <tr>
                        <td>{{ it.get('NumeroOC') or it.get('CodigoOC') or "—" }}</td>
                        <td>{{ it.get('FechaCreacion') or it.get('Fecha') or "—" }}</td>
                        <td>
                          {% set comp = it.get('Comprador') %}
                          {{ (comp and (comp.get('Nombre') or comp)) or "—" }}
                        </td>
                        <td class="text-end">${{ "{:,.0f}".format(v) }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}
        </div>

        <div class="col-md-6">
          <div class="mb-1">
            <strong>Adjudicaciones:</strong> {{ adj_res.get('cantidad', 0) }}
            &nbsp;|&nbsp;
            <strong>Monto adjudicado (muestra):</strong>
            ${{ "{:,.0f}".format(adj_res.get('monto_adjudicado_total', 0)) }}
          </div>
          {% if adj_items|length > 0 %}
            <button class="btn btn-sm btn-outline-secondary" type="button"
                    data-bs-toggle="collapse" data-bs-target="#adjCollapse">
              Ver detalle Adjudicaciones
            </button>
            <div class="collapse mt-2" id="adjCollapse">
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Cód. Licitación</th>
                      <th>Nombre</th>
                      <th>Fecha</th>
                      <th>Comprador</th>
                      <th class="text-end">Monto Adjudicado</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for it in adj_items %}
                      {% set v = (it.get('MontoAdjudicado') or it.get('Monto') or 0) | float %}
                      <tr>
                        <td>{{ it.get('CodigoLicitacion') or "—" }}</td>
                        <td>{{ it.get('Nombre') or "—" }}</td>
                        <td>{{ it.get('FechaAdjudicacion') or it.get('Fecha') or "—" }}</td>
                        <td>
                          {% set comp = it.get('Comprador') %}
                          {{ (comp and (comp.get('Nombre') or comp)) or "—" }}
                        </td>
                        <td class="text-end">${{ "{:,.0f}".format(v) }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>

  <!-- Facturas recientes -->
  <div class="card mb-5">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Últimas 10 facturas</h6>
        <a class="btn btn-sm btn-primary" href="/financiador/marketplace?rut_pagador={{ rut }}">Ver en marketplace</a>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Folio</th><th>Emisor</th><th>Emisión</th><th>Vencimiento</th><th>Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for f in recientes %}
            <tr>
              <td>{{ f.folio }}</td>
              <td>{{ f.razon_social_emisor or f.rut_emisor }}</td>
              <td>{{ f.fecha_emision or "—" }}</td>
              <td>{{ f.fecha_vencimiento or "—" }}</td>
              <td>
                {% set ev = f.estado_vista or f.estado_dte or f.estado_confirmacion or "Pendiente" %}
                <span class="badge
                  {% if ev.lower().startswith('adjudic') %} bg-success
                  {% elif ev.lower().startswith('confirming') %} bg-info
                  {% elif ev.lower() == 'rechazada' %} bg-danger
                  {% elif ev.lower().startswith('confirmada') %} bg-success
                  {% else %} bg-secondary {% endif %}">
                {{ ev }}
                </span>
              </td>
            </tr>
            {% endfor %}
            {% if recientes|length == 0 %}
            <tr><td colspan="5" class="text-muted">Sin registros.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const confirmadas = {{ kpis.totales.confirmadas or 0 }};
  const rechazadas  = {{ kpis.totales.rechazadas  or 0 }};
  const pendientes  = {{ kpis.totales.pendientes  or 0 }};

  new Chart(document.getElementById('pieConfirm'), {
    type: 'pie',
    data: { labels: ['Confirmadas/Adjudicadas','Rechazadas','Pendientes'],
            datasets: [{ data: [confirmadas, rechazadas, pendientes] }] },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  const tmcLabels   = {{ tmc_labels_json   | safe }};
  const tmcData     = {{ tmc_data_json     | safe }};
  const montoLabels = {{ monto_labels_json | safe }};
  const montoData   = {{ monto_data_json   | safe }};

  new Chart(document.getElementById('lineTMC'), {
    type: 'line',
    data: { labels: tmcLabels, datasets: [{ label: 'TMC (días)', data: tmcData }] },
    options: { responsive: true }
  });

  new Chart(document.getElementById('barMontos'), {
    type: 'bar',
    data: { labels: montoLabels, datasets: [{ label: 'Monto confirmado', data: montoData, maxBarThickness: 18 }] },
    options: {
      responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { callback: (v) => Intl.NumberFormat('es-CL').format(v) } },
        x: { grid: { display: false } }
      }
    }
  });
</script>
{% endblock %}